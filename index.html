<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Chess Robot UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    :root {
      --accent: #2563eb;
      --muted: #6b7280;
      --danger: #dc2626;
      --success: #15803d;
      --border: #e5e7eb;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #eef2ff;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 900px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .steps { display: flex; gap: 8px; margin-bottom: 16px; }
    .step { flex: 1; display: flex; align-items: center; gap: 6px; color: var(--muted); }
    .step-circle {
      width: 18px; height: 18px; border-radius: 50%;
      border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem;
    }
    .step.active .step-circle { background: var(--accent); color: white; }
    .step.done .step-circle { background: var(--success); color: white; }

    .card { display: none; border: 1px solid var(--border); padding: 16px; border-radius: 10px; }
    .card.active { display: block; }

    input, select {
      width: 100%; padding: 8px; border-radius: 8px;
      border: 1px solid var(--border); margin-bottom: 10px;
    }
    button {
      width: 100%; padding: 10px; border-radius: 8px;
      border: none; background: var(--accent); color: white;
      cursor: pointer; margin-top: 6px;
    }
    button.secondary { background: var(--muted); }

    .status-box { background: #eef2ff; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    .value { font-weight: bold; }

    .panel { background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
    .board-fen { font-family: monospace; background: white; padding: 8px; border-radius: 8px; border: 1px dashed var(--border); }

    .log { background: #111; color: #eee; padding: 8px; border-radius: 8px; height: 120px; overflow-y: auto; font-family: monospace; }

    .error-flash {
      color: var(--danger);
      font-weight: bold;
    }
  </style>
</head>

<body>
<div class="app">

  <div class="steps">
    <div class="step" data-step="1"><div class="step-circle">1</div>Leistung</div>
    <div class="step" data-step="2"><div class="step-circle">2</div>Spiel</div>
    <div class="step" data-step="3"><div class="step-circle">3</div>Partie</div>
  </div>

  <!-- STEP 1 -->
  <div class="card active" id="card-step1">
    <h3>Engine Leistung</h3>

    <label>Threads</label>
    <input id="threadsInput" type="number" min="1" max="16" value="2">

    <label>Hash (MB)</label>
    <input id="hashInput" type="number" min="16" max="1024" value="64">

    <label>Skill Level</label>
    <input id="skillInput" type="number" min="1" max="20" value="20">

    <button id="step1NextBtn">Weiter</button>
  </div>

  <!-- STEP 2 -->
  <div class="card" id="card-step2">
    <h3>Spiel Einstellungen</h3>

    <label>Denkzeit (ms)</label>
    <input id="movetimeInput" type="number" min="100" max="60000" value="2000">

    <label>Wer beginnt?</label>
    <select id="whoStartsSelect">
      <option value="player">Du (Weiß)</option>
      <option value="engine">Engine (Weiß)</option>
    </select>

    <button id="engineStartBtn">Engine Start</button>
    <button class="secondary" id="step2BackBtn">Zurück</button>
  </div>

  <!-- STEP 3 -->
  <div class="card" id="card-step3">
    <h3>Partie</h3>

    <div class="status-box">
      <div>Wer ist dran: <span class="value" id="statusMain">–</span></div>
      <div>Engine-Zug: <span class="value" id="engineMoveDisplay">–</span></div>
      <div>Schach/Matt: <span class="value" id="statusSub">–</span></div>
      <div>Gewinnchance KI: <span class="value" id="winChanceDisplay">–</span></div>
    </div>

    <label>Dein Zug (z.B. e2e4)</label>
    <input id="opponentMoveInput" type="text">

    <button id="sendMoveBtn">Zug senden</button>
    <button class="secondary" id="newGameBtn">Neue Partie</button>

    <div class="panel">
      <label>FEN</label>
      <div id="fenDisplay" class="board-fen"></div>

      <label>Züge</label>
      <div id="historyDisplay" class="board-fen"></div>

      <label>Engine Log</label>
      <div id="logDisplay" class="log"></div>
    </div>
  </div>

</div>

<script src="chess.min.js"></script>
<script>
(function(){

  const stepElems = document.querySelectorAll('.step');
  const card1 = document.getElementById('card-step1');
  const card2 = document.getElementById('card-step2');
  const card3 = document.getElementById('card-step3');

  const threadsInput = document.getElementById('threadsInput');
  const hashInput = document.getElementById('hashInput');
  const skillInput = document.getElementById('skillInput');

  const movetimeInput = document.getElementById('movetimeInput');
  const whoStartsSelect = document.getElementById('whoStartsSelect');

  const step1NextBtn = document.getElementById('step1NextBtn');
  const step2BackBtn = document.getElementById('step2BackBtn');
  const engineStartBtn = document.getElementById('engineStartBtn');

  const statusMain = document.getElementById('statusMain');
  const statusSub = document.getElementById('statusSub');
  const opponentMoveInput = document.getElementById('opponentMoveInput');
  const sendMoveBtn = document.getElementById('sendMoveBtn');
  const engineMoveDisplay = document.getElementById('engineMoveDisplay');
  const winChanceDisplay = document.getElementById('winChanceDisplay');
  const newGameBtn = document.getElementById('newGameBtn');

  const fenDisplay = document.getElementById('fenDisplay');
  const historyDisplay = document.getElementById('historyDisplay');
  const logDisplay = document.getElementById('logDisplay');

  let engine = null;
  let engineReady = false;
  let enginePlaysWhite = false;
  let chess = new Chess();
  let lastEval = null;

  function log(msg){
    logDisplay.textContent += msg + "\n";
    logDisplay.scrollTop = logDisplay.scrollHeight;
  }

  function setStep(n){
    [card1, card2, card3].forEach((c,i)=>c.classList.toggle('active', i+1===n));
    stepElems.forEach(se=>{
      const s = Number(se.dataset.step);
      se.classList.toggle('active', s===n);
      se.classList.toggle('done', s<n);
    });
  }

  function updateBoard(){
    fenDisplay.textContent = chess.fen();
    historyDisplay.textContent = chess.history().join(" ");
  }

  // ROBUSTE ZUGERKENNUNG
  function applyMoveRaw(input){
    const mv = String(input || '').trim();
    if(!mv) return false;

    // 1) SAN direkt
    let sanTry = chess.move(mv);
    if(sanTry) return true;

    // 2) UCI
    const lower = mv.toLowerCase();
    if(/^[a-h][1-8][a-h][1-8][qrbn]?$/.test(lower)){
      const from = lower.slice(0,2);
      const to = lower.slice(2,4);
      const promo = lower[4];
      const ok = chess.move({from,to,promotion:promo});
      if(ok) return true;
    }

    // 3) SAN normalisiert
    const cleaned = mv.replace(/[+#?!]/g, '');
    sanTry = chess.move(cleaned);
    if(sanTry) return true;

    return false;
  }

  function sendPosition(){
    const moves = chess.history({verbose:true})
      .map(m=>m.from+m.to+(m.promotion||""))
      .join(" ");
    const cmd = moves ? "position startpos moves "+moves : "position startpos";
    engine.postMessage(cmd);
    log("> "+cmd);
  }

  function goEngine(){
    const mt = parseInt(movetimeInput.value)||2000;
    engine.postMessage("go movetime "+mt);
    log("> go movetime "+mt);
    statusMain.textContent = "Engine denkt…";
    engineMoveDisplay.textContent = "…";
  }

  function updateEval(){
    if(lastEval==null){
      winChanceDisplay.textContent = "Noch keine Bewertung.";
      return;
    }
    const cp = lastEval;
    const p = 1/(1+Math.exp(-0.004*cp));
    const engineProb = enginePlaysWhite ? p : (1-p);
    const playerProb = 1-engineProb;
    winChanceDisplay.textContent =
      "Du: "+Math.round(playerProb*100)+"% · Engine: "+Math.round(engineProb*100)+"% (Eval "+cp+" cp)";
  }

  function startEngine(){
    engine = new Worker("stockfish.js");
    engineReady = false;

    engine.onmessage = e=>{
      const line = e.data.trim();
      log("< "+line);

      if(line==="uciok"){
        engine.postMessage("setoption name Threads value "+threadsInput.value);
        engine.postMessage("setoption name Hash value "+hashInput.value);
        engine.postMessage("setoption name Skill Level value "+skillInput.value);
        engine.postMessage("isready");
      }

      // FIX: Engine zieht SOFORT, wenn sie Weiß ist
      if(line==="readyok"){
        engineReady = true;

        if(enginePlaysWhite){
          sendPosition();
          goEngine();
        }
      }

      if(line.startsWith("info") && line.includes("score cp")){
        const cp = parseInt(line.split("score cp ")[1]);
        if(!isNaN(cp)) lastEval = cp;
        updateEval();
      }

      if(line.startsWith("bestmove")){
        const mv = line.split(" ")[1];
        engineMoveDisplay.textContent = mv;
        chess.move({from:mv.slice(0,2), to:mv.slice(2,4), promotion:mv[4]});
        updateBoard();
        statusMain.textContent = "Du bist dran";
      }
    };

    engine.postMessage("uci");
  }

  // EVENTS
  step1NextBtn.onclick = ()=>setStep(2);
  step2BackBtn.onclick = ()=>setStep(1);

  engineStartBtn.onclick = ()=>{
    enginePlaysWhite = (whoStartsSelect.value==="engine");
    chess.reset();
    updateBoard();
    startEngine();
    setStep(3);
    statusMain.textContent = enginePlaysWhite ? "Engine beginnt…" : "Du beginnst";
  };

  // ZUG SENDEN (inkl. ENTER)
  function sendMove(){
    // Fehleranzeige sofort entfernen
    statusSub.classList.remove("error-flash");
    statusSub.textContent = "–";

    const mv = opponentMoveInput.value;

    if(!applyMoveRaw(mv)){
      statusSub.textContent = "Ungültiger Zug";
      statusSub.classList.add("error-flash");

      // Nach Ablauf → komplett ausblenden
      setTimeout(()=>{
        statusSub.classList.remove("error-flash");
        statusSub.textContent = "–";
      },1500);

      return;
    }

    opponentMoveInput.value = "";
    updateBoard();
    sendPosition();
    goEngine();
  }

  sendMoveBtn.onclick = sendMove;

  // ENTER → Zug senden
  opponentMoveInput.addEventListener("keydown", e=>{
    if(e.key === "Enter"){
      e.preventDefault();
      sendMove();
    }
  });

  newGameBtn.onclick = ()=>{
    chess.reset();
    updateBoard();
    lastEval = null;
    winChanceDisplay.textContent = "Noch keine Bewertung.";
    statusMain.textContent = "Neue Partie";
  };

  updateBoard();
})();
</script>

</body>
</html>
